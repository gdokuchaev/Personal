-- Решение написано на синтаксисе T-SQL

CREATE SCHEMA KHD

-- Задание 1

CREATE TABLE KHD.V_WHS (
  WHS_ID   integer primary key not null
, OPEN_DT  date
, CLOSE_DT date
, WORKING  integer
) ;

CREATE TABLE KHD.V_WHS_ALC_LIC (
  WHS_ID            integer not null
, ALC_LIC_ID        integer not null
, ALC_LIC_BEGIN_DT  date not null
, ALC_LIC_END_DT    date not null
) ;

INSERT INTO KHD.V_WHS ( WHS_ID , OPEN_DT , CLOSE_DT , WORKING ) VALUES (1,	'2005-05-05',	'2011-11-23',	0) ;
INSERT INTO KHD.V_WHS ( WHS_ID , OPEN_DT , CLOSE_DT , WORKING ) VALUES (2,	'2007-02-19',	null        ,	1) ;
INSERT INTO KHD.V_WHS ( WHS_ID , OPEN_DT , CLOSE_DT , WORKING ) VALUES (3,	'2009-09-16',	'2014-08-07',	0) ;
INSERT INTO KHD.V_WHS ( WHS_ID , OPEN_DT , CLOSE_DT , WORKING ) VALUES (4,	'2010-03-01',	null        ,	1) ;

INSERT INTO KHD.V_WHS_ALC_LIC ( WHS_ID , ALC_LIC_ID , ALC_LIC_BEGIN_DT , ALC_LIC_END_DT ) VALUES (1,	1,	'2006-05-15',	'2010-11-11') ;
INSERT INTO KHD.V_WHS_ALC_LIC ( WHS_ID , ALC_LIC_ID , ALC_LIC_BEGIN_DT , ALC_LIC_END_DT ) VALUES (2,	1,	'2007-02-22',	'2015-02-22') ;
INSERT INTO KHD.V_WHS_ALC_LIC ( WHS_ID , ALC_LIC_ID , ALC_LIC_BEGIN_DT , ALC_LIC_END_DT ) VALUES (2,	2,	'2007-02-22',	'2099-12-31') ;
INSERT INTO KHD.V_WHS_ALC_LIC ( WHS_ID , ALC_LIC_ID , ALC_LIC_BEGIN_DT , ALC_LIC_END_DT ) VALUES (2,	3,	'2015-02-23',	'2099-12-31') ;
INSERT INTO KHD.V_WHS_ALC_LIC ( WHS_ID , ALC_LIC_ID , ALC_LIC_BEGIN_DT , ALC_LIC_END_DT ) VALUES (4,	2,	'2021-01-01',	'2099-12-31') ;
INSERT INTO KHD.V_WHS_ALC_LIC ( WHS_ID , ALC_LIC_ID , ALC_LIC_BEGIN_DT , ALC_LIC_END_DT ) VALUES (4,	3,	'2015-02-23',	'2099-12-31') ;

--Решение

SELECT 
	whs.WHS_ID,
	OPEN_DT,
	CLOSE_DT,
	ALC_LIC_ID,
	ALC_LIC_BEGIN_DT,
	ALC_LIC_END_DT
FROM
	KHD.V_WHS whs LEFT JOIN (
	SELECT *
	FROM KHD.V_WHS_ALC_LIC
	WHERE ALC_LIC_BEGIN_DT <= SYSDATETIME() AND ALC_LIC_END_DT >= SYSDATETIME()
	) alc ON whs.WHS_ID = alc.WHS_ID

-- Задача 2

CREATE TABLE KHD.T_REF (
  PK   integer primary key not null
, FK   integer
) ;

INSERT INTO KHD.T_REF ( PK , FK ) VALUES (1, 1) ;
INSERT INTO KHD.T_REF ( PK , FK ) VALUES (2, 1) ;
INSERT INTO KHD.T_REF ( PK , FK ) VALUES (3, 2) ;
INSERT INTO KHD.T_REF ( PK , FK ) VALUES (4, 2) ;
INSERT INTO KHD.T_REF ( PK , FK ) VALUES (5, 3) ;
INSERT INTO KHD.T_REF ( PK , FK ) VALUES (6, 3) ;
INSERT INTO KHD.T_REF ( PK , FK ) VALUES (7, 3) ;
INSERT INTO KHD.T_REF ( PK , FK ) VALUES (8, 4) ;

-- Решение
WITH t AS (
	SELECT *
	FROM KHD.T_REF
	EXCEPT
	SELECT min(PK) PK, FK
	FROM KHD.T_REF
	GROUP BY FK
	)
DELETE FROM KHD.T_REF
WHERE PK in (SELECT PK FROM t)

-- Задача 3

CREATE TABLE KHD.EMPLOYEES_LIST (
  EMP_ID    integer primary key not null
, SURNAME   char(32)
, NAME      char(32)
, MIDNAME   char(32)
, GENDER    char(2)
) ;

CREATE TABLE KHD.EMPLOYEES_HISTORY (
  EMP_ID    integer not null constraint FK references KHD.EMPLOYEES_LIST(EMP_ID)
, BEGIN_DT  date
, END_DT    date
) ;

CREATE TABLE KHD.DAYS (
  DAY_ID    date primary key not null
) ;


INSERT INTO KHD.EMPLOYEES_LIST (EMP_ID , SURNAME , NAME , MIDNAME , GENDER) VALUES (1	,'Иванов'	 , 'Иван'	    , 'Иванович'	    , 'м' ) ;
INSERT INTO KHD.EMPLOYEES_LIST (EMP_ID , SURNAME , NAME , MIDNAME , GENDER) VALUES (10	,'Кузнецов'	 , 'Евгений'	, 'Владимирович'	, 'м' ) ;
INSERT INTO KHD.EMPLOYEES_LIST (EMP_ID , SURNAME , NAME , MIDNAME , GENDER) VALUES (11	,'Денисова'	 , 'Анна'	    , 'Андреевна'	    , 'ж' ) ;
INSERT INTO KHD.EMPLOYEES_LIST (EMP_ID , SURNAME , NAME , MIDNAME , GENDER) VALUES (12	,'Попова'	 , 'Ирина'	    , 'Сергеевна'	    , 'ж' ) ;
INSERT INTO KHD.EMPLOYEES_LIST (EMP_ID , SURNAME , NAME , MIDNAME , GENDER) VALUES (13	,'Сидорова'	 , 'Светлана'	, 'Ивановна'	    , 'ж' ) ;
INSERT INTO KHD.EMPLOYEES_LIST (EMP_ID , SURNAME , NAME , MIDNAME , GENDER) VALUES (14	,'Матвеев'	 , 'Алексей'	, 'Петрович'	    , 'м' ) ;
INSERT INTO KHD.EMPLOYEES_LIST (EMP_ID , SURNAME , NAME , MIDNAME , GENDER) VALUES (15	,'Глушко'	 , 'Екатерина'	, 'Александровна'	, 'ж' ) ;
INSERT INTO KHD.EMPLOYEES_LIST (EMP_ID , SURNAME , NAME , MIDNAME , GENDER) VALUES (16	,'Пупкин'	 , 'Василий'	, 'Николаевич'	    , 'м' ) ;
INSERT INTO KHD.EMPLOYEES_LIST (EMP_ID , SURNAME , NAME , MIDNAME , GENDER) VALUES (17	,'Игнатьева' , 'Марина'	    , 'Александровна'	, 'ж' ) ;
INSERT INTO KHD.EMPLOYEES_LIST (EMP_ID , SURNAME , NAME , MIDNAME , GENDER) VALUES (18	,'Сергеев' 	 , 'Михаил'	    , 'Владимирович'	, 'м' ) ;
INSERT INTO KHD.EMPLOYEES_LIST (EMP_ID , SURNAME , NAME , MIDNAME , GENDER) VALUES (2	,'Петров'	 , 'Петр'	    , 'Петрович'	    , 'м' ) ;
INSERT INTO KHD.EMPLOYEES_LIST (EMP_ID , SURNAME , NAME , MIDNAME , GENDER) VALUES (3	,'Романова'	 , 'Елена'	    , 'Евгеньевна'	    , 'ж' ) ;
INSERT INTO KHD.EMPLOYEES_LIST (EMP_ID , SURNAME , NAME , MIDNAME , GENDER) VALUES (4	,'Федорова'	 , 'Кристина'	, 'Сергеевна'	    , 'ж' ) ;
INSERT INTO KHD.EMPLOYEES_LIST (EMP_ID , SURNAME , NAME , MIDNAME , GENDER) VALUES (5	,'Медведева' , 'Алина'	    , 'Федоровна'	    , 'ж' ) ;
INSERT INTO KHD.EMPLOYEES_LIST (EMP_ID , SURNAME , NAME , MIDNAME , GENDER) VALUES (6	,'Попов'	 , 'Александр'	, 'Иванович'	    , 'м' ) ;
INSERT INTO KHD.EMPLOYEES_LIST (EMP_ID , SURNAME , NAME , MIDNAME , GENDER) VALUES (7	,'Николаев'	 , 'Роман'	    , 'Александрович'	, 'м' ) ;
INSERT INTO KHD.EMPLOYEES_LIST (EMP_ID , SURNAME , NAME , MIDNAME , GENDER) VALUES (8	,'Калеева'	 , 'Елена'	    , 'Викторовна'	    , 'ж' ) ;
INSERT INTO KHD.EMPLOYEES_LIST (EMP_ID , SURNAME , NAME , MIDNAME , GENDER) VALUES (9	,'Мартынов'	 , 'Антон'	    , 'Вячеславович'	, 'м' ) ;

INSERT INTO KHD.EMPLOYEES_HISTORY ( EMP_ID , BEGIN_DT , END_DT ) VALUES (1 , '2007-05-12' , '2009-11-04') ;
INSERT INTO KHD.EMPLOYEES_HISTORY ( EMP_ID , BEGIN_DT , END_DT ) VALUES (2 , '2007-05-23' , '2008-06-17') ;
INSERT INTO KHD.EMPLOYEES_HISTORY ( EMP_ID , BEGIN_DT , END_DT ) VALUES (3 , '2007-06-06' , '2008-01-25') ;
INSERT INTO KHD.EMPLOYEES_HISTORY ( EMP_ID , BEGIN_DT , END_DT ) VALUES (4 , '2007-11-23' , '2009-04-16') ;
INSERT INTO KHD.EMPLOYEES_HISTORY ( EMP_ID , BEGIN_DT , END_DT ) VALUES (5 , '2008-05-03' , null) ;
INSERT INTO KHD.EMPLOYEES_HISTORY ( EMP_ID , BEGIN_DT , END_DT ) VALUES (6 , '2008-10-01' , '2012-07-29') ;
INSERT INTO KHD.EMPLOYEES_HISTORY ( EMP_ID , BEGIN_DT , END_DT ) VALUES (7 , '2009-02-08' , '2011-08-08') ;
INSERT INTO KHD.EMPLOYEES_HISTORY ( EMP_ID , BEGIN_DT , END_DT ) VALUES (8 , '2009-10-12' , '2010-03-17') ;
INSERT INTO KHD.EMPLOYEES_HISTORY ( EMP_ID , BEGIN_DT , END_DT ) VALUES (9 , '2009-12-26' , '2011-06-07') ;
INSERT INTO KHD.EMPLOYEES_HISTORY ( EMP_ID , BEGIN_DT , END_DT ) VALUES (10, '2010-03-03' , null) ;
INSERT INTO KHD.EMPLOYEES_HISTORY ( EMP_ID , BEGIN_DT , END_DT ) VALUES (11, '2010-09-01' , '2012-04-20') ;
INSERT INTO KHD.EMPLOYEES_HISTORY ( EMP_ID , BEGIN_DT , END_DT ) VALUES (12, '2011-04-14' , null) ;
INSERT INTO KHD.EMPLOYEES_HISTORY ( EMP_ID , BEGIN_DT , END_DT ) VALUES (13, '2011-07-01' , '2011-09-12') ;
INSERT INTO KHD.EMPLOYEES_HISTORY ( EMP_ID , BEGIN_DT , END_DT ) VALUES (14, '2011-09-22' , null) ;
INSERT INTO KHD.EMPLOYEES_HISTORY ( EMP_ID , BEGIN_DT , END_DT ) VALUES (15, '2011-11-15' , null) ;
INSERT INTO KHD.EMPLOYEES_HISTORY ( EMP_ID , BEGIN_DT , END_DT ) VALUES (16, '2012-03-26' , null) ;
INSERT INTO KHD.EMPLOYEES_HISTORY ( EMP_ID , BEGIN_DT , END_DT ) VALUES (17, '2012-06-11' , null) ;
INSERT INTO KHD.EMPLOYEES_HISTORY ( EMP_ID , BEGIN_DT , END_DT ) VALUES (18, '2012-11-01' , null) ;

INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-01') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-02') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-03') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-04') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-05') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-06') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-07') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-08') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-09') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-10') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-11') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-12') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-13') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-14') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-15') ;

INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-16') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-17') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-18') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-19') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-20') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-21') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-22') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-23') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-24') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-25') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-26') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-27') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-28') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-29') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-30') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-08-31') ;

INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-01') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-02') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-03') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-04') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-05') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-06') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-07') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-08') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-09') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-10') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-11') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-12') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-13') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-14') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-15') ;

INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-16') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-17') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-18') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-19') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-20') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-21') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-22') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-23') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-24') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-25') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-26') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-27') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-28') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-29') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-09-30') ;

INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-10-01') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-10-02') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-10-03') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-10-04') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-10-05') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-10-06') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-10-07') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-10-08') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-10-09') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-10-10') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-10-11') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-10-12') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-10-13') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-10-14') ;
INSERT INTO KHD.DAYS (DAY_ID) VALUES ('2011-10-15') ;

--РЕШЕНИЕ

SELECT DAY_ID, [м] male, [ж] female
FROM
	(
	SELECT DISTINCT
		DAY_ID,
		GENDER,
		count(GENDER) OVER (PARTITION BY DAY_ID, GENDER) qty
	FROM 
		(
		SELECT DAY_ID, GENDER
		FROM 
			(
			SELECT DAY_ID
			FROM KHD.DAYS
			WHERE DAY_ID BETWEEN '2011-09-01' AND '2011-09-30'
			) d CROSS JOIN
			KHD.EMPLOYEES_HISTORY h LEFT JOIN
			KHD.EMPLOYEES_LIST l ON h.EMP_ID = l.EMP_ID
		WHERE
			d.DAY_ID >= h.BEGIN_DT AND 
			(d.DAY_ID <= h.END_DT OR END_DT IS NULL)
		) t
	) t
PIVOT (
	sum(qty)
	FOR GENDER IN ([м],[ж])) t
ORDER BY 1 

/*
Задание может быть решено также без использования PIVOT следующим образом:
подзапрос объявляется CTE, далее к отфильтрованным датам делается левое присоединение
CTE, где отфильтрованы только мужчины, и ещё одно левое присоединение CTE,
где отфильтрованы только женщины, далее запрос группируется по датам и находится
количество мужчин и женщин в каждый день.
*/

-- ЗАДАЧА 4
CREATE TABLE KHD.LIST (
  F1   char(32) primary key not null
, F2   char(32)
) ;

INSERT INTO KHD.LIST (F1,F2) VALUES ('Вторая строка'	, 'Значение второй строки') ;
INSERT INTO KHD.LIST (F1,F2) VALUES ('Первая строка'	, 'Значение первой строки') ;
INSERT INTO KHD.LIST (F1,F2) VALUES ('Пятая строка'	    , 'Значение пятой строки') ;
INSERT INTO KHD.LIST (F1,F2) VALUES ('Третья строка'	, 'Значение третьей строки') ;
INSERT INTO KHD.LIST (F1,F2) VALUES ('Четвертая строка'	, 'Значение четвертой строки') ;

-- РЕШЕНИЕ
/*
В T-SQL может быть использована функция RAND(CHECKSUM(NEWID())).
В Teradata функцию RAND(CHECKSUM(NEWID())) нужно заменить на RANDOM(1, 1000), которая
описана здесь: https://docs.teradata.com/reader/kmuOwjp1zEYg98JsB8fu_A/Rm3P7t1b3v4FdALSVrsGhw.
*/

SELECT t1.F1, t2.F2
FROM
	(
	SELECT F1, ROW_NUMBER() OVER (ORDER BY num) num
	FROM (
		SELECT F1, RAND(CHECKSUM(NEWID())) num
		FROM KHD.LIST
		) t1
	) t1 JOIN
	(
	SELECT F2, ROW_NUMBER() OVER (ORDER BY num) num
	FROM (
		SELECT F2, RAND(CHECKSUM(NEWID())) num
		FROM KHD.LIST
		) t2
	) t2 ON t1.num = t2.num
ORDER BY 1


-- ЗАДАЧА 5
-- Решение написано на синтаксисе PostgreSQL

CREATE TABLE KHD.PROCEDURE_LOG  (
  SESSION_ID        integer not null
, PROCEDURE_NAME    char(32)
, START_TIME        timestamp(0)
, DESCRIPTION       char(255)
) ;

INSERT INTO KHD.PROCEDURE_LOG  ( SESSION_ID , PROCEDURE_NAME , START_TIME , DESCRIPTION) VALUES (201,'Procedure_1','2017-05-14 05:32:05','Started. Removing old data');
INSERT INTO KHD.PROCEDURE_LOG  ( SESSION_ID , PROCEDURE_NAME , START_TIME , DESCRIPTION) VALUES (201,'Procedure_1','2017-05-14 05:37:05','Calculating new data');
INSERT INTO KHD.PROCEDURE_LOG  ( SESSION_ID , PROCEDURE_NAME , START_TIME , DESCRIPTION) VALUES (201,'Procedure_1','2017-05-14 05:38:44','Collecting statistics');
INSERT INTO KHD.PROCEDURE_LOG  ( SESSION_ID , PROCEDURE_NAME , START_TIME , DESCRIPTION) VALUES (201,'Procedure_1','2017-05-14 05:38:56','Finished');
INSERT INTO KHD.PROCEDURE_LOG  ( SESSION_ID , PROCEDURE_NAME , START_TIME , DESCRIPTION) VALUES (201,'Procedure_2','2017-05-14 05:47:17','Started. Inserting data into volatile table#1');
INSERT INTO KHD.PROCEDURE_LOG  ( SESSION_ID , PROCEDURE_NAME , START_TIME , DESCRIPTION) VALUES (201,'Procedure_2','2017-05-14 05:49:17','Inserting data into volatile table#2');
INSERT INTO KHD.PROCEDURE_LOG  ( SESSION_ID , PROCEDURE_NAME , START_TIME , DESCRIPTION) VALUES (201,'Procedure_2','2017-05-14 05:52:29','Merging data into main table');
INSERT INTO KHD.PROCEDURE_LOG  ( SESSION_ID , PROCEDURE_NAME , START_TIME , DESCRIPTION) VALUES (201,'Procedure_2','2017-05-14 05:52:47','Collecting statistics');
INSERT INTO KHD.PROCEDURE_LOG  ( SESSION_ID , PROCEDURE_NAME , START_TIME , DESCRIPTION) VALUES (201,'Procedure_2','2017-05-14 05:53:29','Finished');
INSERT INTO KHD.PROCEDURE_LOG  ( SESSION_ID , PROCEDURE_NAME , START_TIME , DESCRIPTION) VALUES (202,'Procedure_1','2017-05-15 05:50:47','Started. Removing old data');
INSERT INTO KHD.PROCEDURE_LOG  ( SESSION_ID , PROCEDURE_NAME , START_TIME , DESCRIPTION) VALUES (202,'Procedure_1','2017-05-15 05:58:11','Calculating new data');
INSERT INTO KHD.PROCEDURE_LOG  ( SESSION_ID , PROCEDURE_NAME , START_TIME , DESCRIPTION) VALUES (202,'Procedure_1','2017-05-15 05:59:08','Collecting statistics');
INSERT INTO KHD.PROCEDURE_LOG  ( SESSION_ID , PROCEDURE_NAME , START_TIME , DESCRIPTION) VALUES (202,'Procedure_1','2017-05-15 06:01:23','Finished');

--Решение
SELECT *,
	lead(start_time) OVER () - start_time duration
FROM KHD.PROCEDURE_LOG ;
